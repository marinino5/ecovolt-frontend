<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Ecovolt ‚Äì Micromovilidad Inteligente</title>
    
    <!-- Fuentes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">
    
    <!-- Estilos -->
    <link rel="stylesheet" href="styles.css">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    
    <style>
        /* Estilos adicionales para garantizar funcionalidad */
        .ha-card { cursor: pointer; transition: all 0.3s ease; }
        .ha-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.12); }
        #realtime-indicator { font-family: Inter, system-ui, sans-serif; }
        
        /* Grid de tarjetas IoT */
        .ha-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .ha-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .ha-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }

        .ha-card__header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .ha-card__title {
            font-weight: 600;
            color: #1e293b;
            font-size: 14px;
        }

        .ha-card__timestamp {
            font-size: 12px;
            color: #64748b;
        }

        .ha-card__value {
            font-size: 24px;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 12px;
        }

        .ha-card__sparkline {
            height: 40px;
            width: 100%;
            min-height: 40px;
            margin-top: 8px;
            border-radius: 6px;
            overflow: hidden;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
        }

        .ha-card__sparkline svg {
            width: 100%;
            height: 100%;
            display: block;
        }

        .ha-card__actions {
            margin-top: 12px;
        }

        .ha-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .ha-btn:hover {
            background: #2563eb;
        }
    </style>
</head>

<body>
    <!-- ===== NAVBAR ===== -->
    <header class="nav">
        <div class="nav__inner">
            <a class="brand" href="#home" aria-label="Ecovolt Home">
                <span class="brand__logo" aria-hidden="true">
                    <svg viewBox="0 0 64 64">
                        <defs>
                            <linearGradient id="g1" x1="0" x2="1" y1="0" y2="1">
                                <stop offset="0" stop-color="#2dd4bf"/>
                                <stop offset="1" stop-color="#22d3ee"/>
                            </linearGradient>
                        </defs>
                        <circle cx="32" cy="32" r="28" fill="url(#g1)" opacity=".18"/>
                        <path d="M32 8 L16 36 h12 v20 L48 28 H36 V8 Z" fill="url(#g1)"/>
                    </svg>
                </span>
                <span class="brand__text"><b>Eco</b>Volt</span>
            </a>
            
            <nav class="menu" id="menu">
                <a href="#home" class="is-active">Inicio</a>
                <a href="#how">C√≥mo Funciona</a>
                <a href="#panel">Panel</a>
                <a href="#precios">Precios</a>
            </nav>
            
            <div class="nav__cta">
                <button class="btn btn--ghost">Iniciar Sesi√≥n</button>
                <button class="btn btn--pill">Registrarse</button>
                <button class="hamb" id="hamb" aria-label="Abrir men√∫">
                    <span></span><span></span><span></span>
                </button>
            </div>
        </div>
    </header>

    <!-- ===== HERO ===== -->
    <section id="home" class="hero">
        <div class="blob blob--a"></div>
        <div class="blob blob--b"></div>
        
        <div class="hero__inner">
            <div class="hero__copy">
                <h1>
                    Movilidad <span class="grad">Sostenible</span> para un <span class="grad">Futuro Mejor</span>
                </h1>
                <p>
                    Descubre la red de veh√≠culos el√©ctricos m√°s amplia de la ciudad. Reserva, usa y contribuye al medio ambiente en cada viaje.
                </p>
                <div class="hero__actions">
                    <a class="btn btn--outline" href="#how">Ver C√≥mo Funciona</a>
                </div>
            </div>
            
            <!-- Ilustraci√≥n -->
            <div class="hero__art" aria-hidden="true">
                <svg viewBox="0 0 520 320" width="100%" height="100%" style="max-width:520px; display:block; margin-inline:auto; filter: drop-shadow(0 28px 60px rgba(0,0,0,.28));">
                    <defs>
                        <radialGradient id="halo" cx="50%" cy="45%" r="55%">
                            <stop offset="0%" stop-color="rgba(255,255,255,0.55)" />
                            <stop offset="100%" stop-color="rgba(255,255,255,0)" />
                        </radialGradient>
                    </defs>
                    <ellipse cx="260" cy="160" rx="220" ry="120" fill="url(#halo)" />
                    <g transform="translate(150,60)" fill="#ffffff">
                        <rect x="0" y="30" width="160" height="170" rx="26" opacity="0.92"/>
                        <rect x="-8" y="195" width="176" height="18" rx="9" opacity="0.92"/>
                        <path d="M90 70 L60 120 H85 L70 160 L120 105 H95 L110 70 Z" fill="#0ea5e9" opacity="0.95"/>
                        <path d="M160 120 C210 120, 210 170, 175 170 L150 170 L150 145 L172 145 C185 145, 185 130, 172 130 L160 130 Z" />
                        <circle cx="194" cy="136" r="11"/>
                        <circle cx="194" cy="160" r="11"/>
                        <path d="M175 115 h35 a18 18 0 0 1 18 18 v35 a18 18 0 0 1 -18 18 h-35 a0 0 0 0 1 0 0 v-71 a0 0 0 0 1 0 0 z" fill="#ffffff" opacity="0.92"/>
                    </g>
                </svg>
            </div>
        </div>
    </section>

    <!-- ===== C√ìMO FUNCIONA ===== -->
    <section id="how" class="how2">
        <div class="how2__head">
            <h2>¬øC√≥mo Funciona?</h2>
            <div class="how2__line"></div>
            <p class="how2__sub">Empieza en minutos y mu√©vete con micromovilidad el√©ctrica de forma segura y sostenible.</p>
        </div>
        
        <div class="how2__grid">
            <!-- Paso 1 -->
            <article class="step2">
                <div class="step2__bar"></div>
                <span class="step2__num">1</span>
                <div class="step2__icon step2__icon--a">
                    <span class="step2__icon-glyph">üë§</span>
                </div>
                <h3>Reg√≠strate</h3>
                <p>Crea tu cuenta y accede a toda nuestra red de veh√≠culos el√©ctricos disponibles 24/7.</p>
            </article>
            
            <!-- Paso 2 -->
            <article class="step2">
                <div class="step2__bar"></div>
                <span class="step2__num">2</span>
                <div class="step2__icon step2__icon--b">
                    <span class="step2__icon-glyph">üìç</span>
                </div>
                <h3>Encuentra</h3>
                <p>Localiza la estaci√≥n m√°s cercana usando nuestra app y revisa la disponibilidad en tiempo real.</p>
            </article>
            
            <!-- Paso 3 -->
            <article class="step2">
                <div class="step2__bar"></div>
                <span class="step2__num">3</span>
                <div class="step2__icon step2__icon--c">
                    <span class="step2__icon-glyph">üîì</span>
                </div>
                <h3>Desbloquea</h3>
                <p>Escanea el c√≥digo QR o usa tu smartphone para desbloquear tu veh√≠culo de forma segura e instant√°nea.</p>
            </article>
            
            <!-- Paso 4 -->
            <article class="step2">
                <div class="step2__bar"></div>
                <span class="step2__num">4</span>
                <div class="step2__icon step2__icon--d">
                    <span class="step2__icon-glyph">üõµ</span>
                </div>
                <h3>Viaja</h3>
                <p>Disfruta tu viaje ecol√≥gico y devuelve el veh√≠culo en cualquier estaci√≥n habilitada.</p>
            </article>
        </div>
    </section>

    <!-- ===== PANEL IoT ===== -->
    <section id="panel" class="panel">
        <div class="section__head">
            <h2 class="iot-title">Panel de Monitoreo IoT</h2>
            <p class="section__sub">Datos en tiempo real de las estaciones EcoVolt</p>
        </div>
        
        <!-- Grid de sensores estilo Home Assistant -->
        <div class="ha-grid" id="panelGrid">
            <!-- Temperatura -->
            <div class="ha-card js-sensor-card" data-key="temperature">
                <div class="ha-card__header">
                    <span class="ha-card__title">Temperatura</span>
                    <span class="ha-card__timestamp">Hace 2 min</span>
                </div>
                <div class="ha-card__value">24.5 ¬∞C</div>
                <div class="ha-card__sparkline" id="sparkline-temperature">
                    <!-- Sparkline se insertar√° aqu√≠ -->
                </div>
            </div>
            
            <!-- Potencia -->
            <div class="ha-card js-sensor-card" data-key="power">
                <div class="ha-card__header">
                    <span class="ha-card__title">Potencia</span>
                    <span class="ha-card__timestamp">Hace 2 min</span>
                </div>
                <div class="ha-card__value">1.47 kW</div>
                <div class="ha-card__sparkline" id="sparkline-power">
                    <!-- Sparkline se insertar√° aqu√≠ -->
                </div>
            </div>
            
            <!-- Voltaje -->
            <div class="ha-card js-sensor-card" data-key="voltage">
                <div class="ha-card__header">
                    <span class="ha-card__title">Voltaje</span>
                    <span class="ha-card__timestamp">Hace 2 min</span>
                </div>
                <div class="ha-card__value">220 V</div>
                <div class="ha-card__sparkline" id="sparkline-voltage">
                    <!-- Sparkline se insertar√° aqu√≠ -->
                </div>
            </div>
            
            <!-- Bater√≠a -->
            <div class="ha-card js-sensor-card" data-key="battery">
                <div class="ha-card__header">
                    <span class="ha-card__title">Bater√≠a</span>
                    <span class="ha-card__timestamp">Hace 2 min</span>
                </div>
                <div class="ha-card__value">77 %</div>
                <div class="ha-card__sparkline" id="sparkline-battery">
                    <!-- Sparkline se insertar√° aqu√≠ -->
                </div>
                <div class="ha-card__actions">
                    <button class="ha-btn" onclick="aplicarRetrocesoCarga()">Forzar carga</button>
                </div>
            </div>
            
            <!-- √öltima Carga -->
            <div class="ha-card js-sensor-card" data-key="lastCharge">
                <div class="ha-card__header">
                    <span class="ha-card__title">√öltima carga</span>
                    <span class="ha-card__timestamp">Hace 2 min</span>
                </div>
                <div class="ha-card__value">41 min</div>
                <div class="ha-card__sparkline" id="sparkline-lastCharge">
                    <!-- Sparkline se insertar√° aqu√≠ -->
                </div>
            </div>
        </div>
        
        <!-- Tabla de datos hist√≥ricos -->
        <div id="historical-data-container" style="max-width: 1200px; margin: 40px auto; padding: 0 20px;"></div>
    </section>

    <!-- ===== PRECIOS ===== -->
    <section id="precios" class="pricing">
        <div class="section__head">
            <h2>Precios</h2>
            <div class="underline"></div>
        </div>
        
        <div class="pricing__grid">
            <article class="price">
                <h3>B√°sico</h3>
                <div class="price__num">$9<span>/mes</span></div>
                <ul>
                    <li>30 min gratis diarios</li>
                    <li>Acceso a bicicletas</li>
                    <li>Soporte b√°sico</li>
                    <li>App m√≥vil</li>
                </ul>
                <button class="btn btn--light">Elegir Plan</button>
            </article>
            
            <article class="price price--featured">
                <div class="badge">M√°s popular</div>
                <h3>Premium</h3>
                <div class="price__num">$19<span>/mes</span></div>
                <ul>
                    <li>60 min gratis diarios</li>
                    <li>Acceso a bicicletas y scooters</li>
                    <li>Reservas prioritarias</li>
                    <li>Soporte 24/7</li>
                </ul>
                <button class="btn btn--cta">Elegir Plan</button>
            </article>
            
            <article class="price">
                <h3>Enterprise</h3>
                <div class="price__num">$49<span>/mes</span></div>
                <ul>
                    <li>Viajes ilimitados</li>
                    <li>Gesti√≥n de equipos</li>
                    <li>Reportes detallados</li>
                    <li>Soporte dedicado</li>
                </ul>
                <button class="btn btn--light">Contactar Ventas</button>
            </article>
        </div>
    </section>

    <!-- ===== FOOTER ===== -->
    <footer class="footerX">
        <div class="footerX__wrap">
            <div class="footerX__grid">
                <div class="fcol fcol--brand">
                    <h4 class="fcol__title">EcoVolt</h4>
                    <span class="fcol__line"></span>
                    <p>
                        Revolucionando la movilidad urbana con soluciones sostenibles y tecnolog√≠a de vanguardia.
                    </p>
                </div>
                
                <div class="fcol">
                    <h4 class="fcol__title">Enlaces R√°pidos</h4>
                    <ul class="flist">
                        <li><a href="#home">Inicio</a></li>
                        <li><a href="#how">C√≥mo Funciona</a></li>
                        <li><a href="#precios">Precios</a></li>
                    </ul>
                </div>
                
                <div class="fcol">
                    <h4 class="fcol__title">Soporte</h4>
                    <ul class="flist">
                        <li><a href="#">Centro de Ayuda</a></li>
                        <li><a href="#">T√©rminos y Condiciones</a></li>
                        <li><a href="#">Pol√≠tica de Privacidad</a></li>
                    </ul>
                </div>
                
                <div class="fcol">
                    <h4 class="fcol__title">Contacto</h4>
                    <ul class="flist flist--contact">
                        <li>+57 304 2129 602</li>
                        <li>info@ecovolt.com</li>
                        <li>Universidad Aut√≥noma, Bucaramanga</li>
                    </ul>
                </div>
            </div>
            
            <hr class="fsep" />
            
            <div class="fcopy">¬© 2025 EcoVolt. Todos los derechos reservados.</div>
        </div>
    </footer>

    <!-- Modal Home Assistant -->
    <div id="ha-modal" class="iot-modal-backdrop is-hidden">
        <div class="ha-modal">
            <div class="ha-modal__header">
                <div>
                    <h3 class="ha-modal__title" id="ha-modal-title">Sensor</h3>
                    <p class="ha-modal__subtitle" id="ha-modal-subtitle">Descripci√≥n del sensor</p>
                </div>
                <button class="ha-modal__close" id="ha-modal-close">√ó</button>
            </div>
            
            <div class="ha-modal__body">
                <div class="ha-modal__stats">
                    <div class="ha-modal__stat">
                        <span class="ha-modal__stat-label">Actual</span>
                        <span class="ha-modal__stat-value" id="ha-modal-current">--</span>
                    </div>
                    <div class="ha-modal__stat">
                        <span class="ha-modal__stat-label">M√≠nimo</span>
                        <span class="ha-modal__stat-value" id="ha-modal-min">--</span>
                    </div>
                    <div class="ha-modal__stat">
                        <span class="ha-modal__stat-label">M√°ximo</span>
                        <span class="ha-modal__stat-value" id="ha-modal-max">--</span>
                    </div>
                    <div class="ha-modal__stat">
                        <span class="ha-modal__stat-label">Promedio</span>
                        <span class="ha-modal__stat-value" id="ha-modal-avg">--</span>
                    </div>
                </div>
                
                <div class="ha-modal__chart" id="ha-modal-chart"></div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="./config.js"></script>
    <script src="./iotapp.js"></script>
    <script src="./main.js"></script>

<script>
// =====================================================
// SISTEMA DE GR√ÅFICAS CONECTADO AL BACKEND REAL
// =====================================================

const sensorsConfig = {
    temperature: { 
        name: "Temperatura", 
        unit: "¬∞C", 
        color: "#ef4444", 
        description: "Temperatura ambiente de la estaci√≥n",
        min: 20,
        max: 40,
        normalRange: [22, 30]
    },
    power: { 
        name: "Potencia", 
        unit: "kW", 
        color: "#8b5cf6", 
        description: "Potencia consumida por la estaci√≥n",
        min: 0.4,
        max: 3.0,
        normalRange: [0.5, 2.5]
    },
    voltage: { 
        name: "Voltaje", 
        unit: "V", 
        color: "#eab308", 
        description: "Voltaje del sistema de carga",
        min: 210,
        max: 240,
        normalRange: [215, 225]
    },
    battery: { 
        name: "Bater√≠a", 
        unit: "%", 
        color: "#22c55e", 
        description: "Nivel de bater√≠a disponible",
        min: 5,
        max: 100,
        normalRange: [20, 90]
    },
 lastCharge: { 
    name: "√öltima carga", 
    unit: "min", 
    color: "#3b82f6", 
    description: "Tiempo desde la √∫ltima carga completa",
    min: 0,
    max: 240, // 4 horas m√°ximo
    normalRange: [0, 120] // Normal: 0-2 horas
}
};

// Almacenamiento de datos hist√≥ricos del backend
let sensorData = {
    temperature: [],
    power: [],
    voltage: [],
    battery: [],
    lastCharge: []
};

// WebSocket para datos en tiempo real
let wsConnection = null;

// ===== CONEXI√ìN WEBSOCKET MEJORADA =====
function connectWebSocket() {
    // Si estamos en GitHub Pages, no intentar conectar WebSocket
    if (window.location.hostname.includes('github.io')) {
        console.log('üåê Modo GitHub Pages - Usando datos simulados');
        generarDatosInicialesReales();
        simularActualizacionesEnTiempoReal();
        return;
    }

    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}`;
    
    try {
        wsConnection = new WebSocket(wsUrl);
        
        wsConnection.onopen = function() {
            console.log('‚úÖ WebSocket conectado al backend');
            document.querySelectorAll('.ha-card__timestamp').forEach(ts => {
                ts.textContent = 'En tiempo real';
                ts.style.color = '#22c55e';
            });
        };
        
        wsConnection.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);
                procesarMensajeWebSocket(data);
            } catch (error) {
                console.error('Error procesando mensaje WebSocket:', error);
            }
        };
        
        wsConnection.onclose = function() {
            console.log('üîå WebSocket desconectado, usando modo simulaci√≥n');
            document.querySelectorAll('.ha-card__timestamp').forEach(ts => {
                ts.textContent = 'Modo simulaci√≥n';
                ts.style.color = '#eab308';
            });
            generarDatosInicialesReales();
            simularActualizacionesEnTiempoReal();
        };
        
        wsConnection.onerror = function(error) {
            console.error('‚ùå Error WebSocket, usando modo simulaci√≥n:', error);
            generarDatosInicialesReales();
            simularActualizacionesEnTiempoReal();
        };
        
    } catch (error) {
        console.log('WebSocket no disponible, usando modo simulaci√≥n');
        generarDatosInicialesReales();
        simularActualizacionesEnTiempoReal();
    }
}

// ===== SIMULACI√ìN DE DATOS EN TIEMPO REAL =====
function simularActualizacionesEnTiempoReal() {
    setInterval(() => {
        Object.keys(sensorsConfig).forEach(sensorId => {
            if (sensorData[sensorId] && sensorData[sensorId].length > 0) {
                const lastValue = sensorData[sensorId][sensorData[sensorId].length - 1];
                const config = sensorsConfig[sensorId];
                
                // Simular cambios realistas
                let newValue;
                switch(sensorId) {
                    case 'temperature':
                        newValue = lastValue + (Math.random() - 0.5) * 0.3;
                        break;
                    case 'power':
                        newValue = lastValue + (Math.random() - 0.5) * 0.1;
                        break;
                    case 'voltage':
                        newValue = lastValue + (Math.random() - 0.5) * 0.5;
                        break;
                    case 'battery':
                        newValue = Math.max(10, lastValue - 0.1 + (Math.random() - 0.5) * 0.2);
                        break;
                    case 'lastCharge':
                        newValue = lastValue + 1;
                        break;
                    default:
                        newValue = lastValue + (Math.random() - 0.5) * 0.2;
                }
                
                // Aplicar l√≠mites
                newValue = Math.max(config.min, Math.min(config.max, newValue));
                
                actualizarDatosSensor(sensorId, newValue);
                
                // Actualizar valor principal en la tarjeta
                const valorElemento = document.querySelector(`[data-key="${sensorId}"] .ha-card__value`);
                if (valorElemento) {
                    valorElemento.textContent = `${newValue.toFixed(sensorId === 'power' ? 2 : 1)} ${config.unit}`;
                }
            }
        });
        
        // Actualizar timestamp
        document.querySelectorAll('.ha-card__timestamp').forEach(ts => {
            ts.textContent = 'Modo simulaci√≥n';
            ts.style.color = '#eab308';
        });
        
    }, 3000); // Actualizar cada 3 segundos
}

// ===== PROCESAR DATOS DEL BACKEND =====
function procesarMensajeWebSocket(data) {
    switch(data.type) {
        case 'sensor_update':
            // Actualizar datos en tiempo real
            actualizarDatosRealtime(data.data);
            break;
            
        case 'connection_established':
            console.log('üîó Conectado al backend IoT');
            break;
            
        case 'control_update':
            console.log('üîÑ Actualizaci√≥n de control:', data);
            break;
    }
}

function actualizarDatosRealtime(realData) {
    // Actualizar valores principales en las tarjetas
    const elementos = {
        temperature: document.querySelector('[data-key="temperature"] .ha-card__value'),
        power: document.querySelector('[data-key="power"] .ha-card__value'),
        voltage: document.querySelector('[data-key="voltage"] .ha-card__value'),
        battery: document.querySelector('[data-key="battery"] .ha-card__value'),
        lastCharge: document.querySelector('[data-key="lastCharge"] .ha-card__value')
    };

    if (elementos.temperature && realData.temperature !== undefined) {
        elementos.temperature.textContent = `${realData.temperature.toFixed(1)} ¬∞C`;
        actualizarDatosSensor('temperature', realData.temperature);
    }
    if (elementos.power && realData.power !== undefined) {
        elementos.power.textContent = `${realData.power.toFixed(2)} kW`;
        actualizarDatosSensor('power', realData.power);
    }
    if (elementos.voltage && realData.voltage !== undefined) {
        elementos.voltage.textContent = `${realData.voltage.toFixed(1)} V`;
        actualizarDatosSensor('voltage', realData.voltage);
    }
    if (elementos.battery && realData.battery !== undefined) {
        elementos.battery.textContent = `${realData.battery.toFixed(1)} %`;
        actualizarDatosSensor('battery', realData.battery);
    }
    if (elementos.lastCharge && realData.lastChargeMinutes !== undefined) {
        elementos.lastCharge.textContent = `${realData.lastChargeMinutes} min`;
        actualizarDatosSensor('lastCharge', realData.lastChargeMinutes);
    }

    // Actualizar timestamp
    document.querySelectorAll('.ha-card__timestamp').forEach(ts => {
        ts.textContent = 'En tiempo real';
        ts.style.color = '#22c55e';
    });
}

// ===== CARGAR DATOS HIST√ìRICOS DEL BACKEND =====
async function cargarDatosHistoricos() {
    try {
        const response = await fetch('/api/history/temperature?hours=24');
        if (response.ok) {
            const data = await response.json();
            console.log('üìä Datos hist√≥ricos cargados:', data.totalPoints, 'puntos');
            
            // Procesar datos hist√≥ricos para cada sensor
            await Promise.all(
                Object.keys(sensorsConfig).map(async sensorId => {
                    const histResponse = await fetch(`/api/history/${sensorId}?hours=24`);
                    if (histResponse.ok) {
                        const histData = await histResponse.json();
                        sensorData[sensorId] = histData.data.map(item => item.v).slice(-20);
                    }
                })
            );
            
            actualizarTodasSparklines();
        }
    } catch (error) {
        console.log('‚ö†Ô∏è Usando datos simulados hasta que el backend est√© disponible');
        generarDatosInicialesReales();
    }
}

// ===== GENERAR DATOS INICIALES REALISTAS =====
function generarDatosInicialesReales() {
    const valoresBase = {
        temperature: 24.5,
        power: 1.47,
        voltage: 220.0,
        battery: 77.0,
        lastCharge: 41
    };

    Object.keys(sensorsConfig).forEach(sensorId => {
        const base = valoresBase[sensorId];
        const config = sensorsConfig[sensorId];
        
        // Generar 20 puntos con variaci√≥n realista basada en rangos del backend
        sensorData[sensorId] = Array.from({length: 20}, (_, i) => {
            const progreso = i / 19;
            const variacion = (Math.random() - 0.5) * (config.max - config.min) * 0.08;
            
            // Patrones espec√≠ficos para cada sensor
            switch(sensorId) {
                case 'temperature':
                    // Ciclo diurno de temperatura
                    const cicloDia = Math.sin(progreso * Math.PI * 2) * 2;
                    return base + cicloDia + variacion;
                
                case 'power':
                    // Patr√≥n de uso con picos
                    const pico = Math.sin(progreso * Math.PI * 4) > 0.7 ? Math.random() * 1.5 : 0;
                    return Math.max(0.4, base + pico + variacion);
                
                case 'voltage':
                    // Voltaje estable con peque√±as fluctuaciones
                    return base + (Math.random() - 0.5) * 4;
                
                case 'battery':
                    // Descarga gradual con peque√±as recuperaciones
                    const tendencia = -progreso * 15;
                    const recuperacion = Math.random() > 0.8 ? 5 : 0;
                    return Math.max(15, base + tendencia + recuperacion + variacion);
                
                case 'lastCharge':
                    // Tiempo acumulativo con reset ocasional
                    const acumulado = progreso * 180;
                    const reset = Math.random() > 0.9 ? -acumulado : 0;
                    return (acumulado + reset + variacion) % 200;
                
                default:
                    return base + variacion;
            }
        });
    });
    
    actualizarTodasSparklines();
}

// ===== ACTUALIZAR DATOS DE SENSOR =====
function actualizarDatosSensor(sensorId, nuevoValor) {
    if (!sensorData[sensorId]) sensorData[sensorId] = [];
    
    // Agregar nuevo dato manteniendo coherencia con rangos
    const config = sensorsConfig[sensorId];
    const valorLimitado = Math.max(config.min, Math.min(config.max, nuevoValor));
    
    sensorData[sensorId].push(valorLimitado);
    
    // Mantener solo los √∫ltimos 20 puntos para las sparklines
    if (sensorData[sensorId].length > 20) {
        sensorData[sensorId] = sensorData[sensorId].slice(-20);
    }
    
    // Actualizar sparkline
    const container = document.getElementById(`sparkline-${sensorId}`);
    if (container && config) {
        renderSparkline(container, sensorData[sensorId], config.color, config.min, config.max);
    }
}

// ===== RENDERIZAR SPARKLINE MEJORADA =====
function renderSparkline(container, data, color, minRange, maxRange) {
    if (!container || !data || data.length < 2) {
        container.innerHTML = '<div style="color: #666; text-align: center; padding: 10px; font-size: 12px;">Cargando datos...</div>';
        return;
    }
    
    const width = container.clientWidth || 200;
    const height = 40;
    const min = minRange !== undefined ? minRange : Math.min(...data);
    const max = maxRange !== undefined ? maxRange : Math.max(...data);
    const range = Math.max(1, max - min);
    
    const points = data.map((value, index) => {
        const x = (index / (data.length - 1)) * width;
        const y = height - ((value - min) / range) * height;
        return `${x},${y}`;
    }).join(' ');
    
    // Determinar color basado en valores actuales
    const lastValue = data[data.length - 1];
    const config = Object.values(sensorsConfig).find(c => c.color === color);
    let lineColor = color;
    let status = 'normal';
    
    if (config && config.normalRange) {
        if (lastValue < config.normalRange[0]) {
            lineColor = '#eab308'; // amarillo - alerta
            status = 'bajo';
        } else if (lastValue > config.normalRange[1]) {
            lineColor = '#ef4444'; // rojo - peligro
            status = 'alto';
        }
    }
    
    container.innerHTML = `
        <svg viewBox="0 0 ${width} ${height}" preserveAspectRatio="none" style="width:100%; height:100%;">
            <defs>
                <linearGradient id="grad-${color.replace('#', '')}" x1="0" y1="0" x2="0" y2="1">
                    <stop offset="0%" stop-color="${lineColor}" stop-opacity="0.4"/>
                    <stop offset="100%" stop-color="${lineColor}" stop-opacity="0.05"/>
                </linearGradient>
            </defs>
            <path d="M0,${height} L${points.replace(/ /g, ' L')} L${width},${height} Z" 
                  fill="url(#grad-${color.replace('#', '')})"/>
            <polyline points="${points}" fill="none" stroke="${lineColor}" 
                     stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            
            <!-- √öltimo punto destacado -->
            <circle cx="${width}" cy="${height - ((lastValue - min) / range) * height}" 
                   r="3" fill="${lineColor}" stroke="#ffffff" stroke-width="1.5"/>
        </svg>
    `;
    
    // Agregar tooltip con informaci√≥n del estado
    container.title = `√öltimo valor: ${lastValue.toFixed(1)} | Estado: ${status}`;
}

// ===== ACTUALIZAR TODAS LAS SPARKLINES =====
function actualizarTodasSparklines() {
    Object.keys(sensorsConfig).forEach(sensorId => {
        const container = document.getElementById(`sparkline-${sensorId}`);
        const config = sensorsConfig[sensorId];
        if (container && sensorData[sensorId] && sensorData[sensorId].length > 0) {
            renderSparkline(container, sensorData[sensorId], config.color, config.min, config.max);
        }
    });
}

// ===== AN√ÅLISIS DE TENDENCIAS =====
function analizarTendencias(sensorId, datos) {
    if (!datos || datos.length < 5) return null;
    
    const ultimos5 = datos.slice(-5);
    const tendencia = ultimos5[ultimos5.length - 1] - ultimos5[0];
    const config = sensorsConfig[sensorId];
    const valorActual = datos[datos.length - 1];
    
    let estado = 'normal';
    if (config && config.normalRange) {
        if (valorActual < config.normalRange[0]) estado = 'bajo';
        else if (valorActual > config.normalRange[1]) estado = 'alto';
    }
    
    return {
        tendencia: tendencia,
        direccion: tendencia > 0 ? 'subiendo' : tendencia < 0 ? 'bajando' : 'estable',
        velocidad: Math.abs(tendencia) / 5,
        estado: estado,
        valorActual: valorActual
    };
}

// ===== MODAL CON AN√ÅLISIS COMPLETO =====
function openTelemetryModal(sensorId) {
    const config = sensorsConfig[sensorId];
    const data = sensorData[sensorId];
    
    if (!config || !data || data.length === 0) {
        alert('No hay datos disponibles para este sensor');
        return;
    }
    
    const modal = document.getElementById('ha-modal');
    const title = document.getElementById('ha-modal-title');
    const subtitle = document.getElementById('ha-modal-subtitle');
    const current = document.getElementById('ha-modal-current');
    const min = document.getElementById('ha-modal-min');
    const max = document.getElementById('ha-modal-max');
    const avg = document.getElementById('ha-modal-avg');
    const chart = document.getElementById('ha-modal-chart');
    
    if (!modal || !title) return;
    
    // Calcular estad√≠sticas
    const currentValue = data[data.length - 1];
    const minValue = Math.min(...data);
    const maxValue = Math.max(...data);
    const avgValue = data.reduce((a, b) => a + b, 0) / data.length;
    const tendencia = analizarTendencias(sensorId, data);
    
    // Actualizar modal
    title.textContent = config.name;
    subtitle.textContent = `${config.description} | Tendencia: ${tendencia ? tendencia.direccion : 'N/A'}`;
    current.textContent = `${currentValue.toFixed(config.unit === 'kW' ? 2 : 1)} ${config.unit}`;
    min.textContent = `${minValue.toFixed(config.unit === 'kW' ? 2 : 1)} ${config.unit}`;
    max.textContent = `${maxValue.toFixed(config.unit === 'kW' ? 2 : 1)} ${config.unit}`;
    avg.textContent = `${avgValue.toFixed(config.unit === 'kW' ? 2 : 1)} ${config.unit}`;
    
    // Renderizar gr√°fica del modal
    renderModalChart(chart, data, config.color, config.unit, config.min, config.max);
    
    // Mostrar modal
    modal.classList.remove('is-hidden');
}

function renderModalChart(container, data, color, unit, minRange, maxRange) {
    if (!container || !data || data.length < 2) {
        container.innerHTML = '<div style="color: #666; text-align: center; padding: 40px;">No hay datos suficientes para mostrar</div>';
        return;
    }
    
    const width = 400;
    const height = 200;
    const min = minRange !== undefined ? minRange : Math.min(...data);
    const max = maxRange !== undefined ? maxRange : Math.max(...data);
    const range = Math.max(1, max - min);
    
    const points = data.map((value, index) => {
        const x = (index / (data.length - 1)) * width;
        const y = height - ((value - min) / range) * height;
        return `${x},${y}`;
    }).join(' ');
    
    container.innerHTML = `
        <svg viewBox="0 0 ${width} ${height}" preserveAspectRatio="none" style="width:100%; height:200px;">
            <defs>
                <linearGradient id="modal-grad" x1="0" y1="0" x2="0" y2="1">
                    <stop offset="0%" stop-color="${color}" stop-opacity="0.4"/>
                    <stop offset="100%" stop-color="${color}" stop-opacity="0.05"/>
                </linearGradient>
            </defs>
            
            <!-- L√≠nea de referencia de rango normal -->
            <line x1="0" y1="${height - ((sensorsConfig[Object.keys(sensorsConfig).find(k => sensorsConfig[k].color === color)]?.normalRange?.[0] - min) / range) * height || height/2}" 
                  x2="${width}" y2="${height - ((sensorsConfig[Object.keys(sensorsConfig).find(k => sensorsConfig[k].color === color)]?.normalRange?.[0] - min) / range) * height || height/2}" 
                  stroke="#22c55e" stroke-width="1" stroke-dasharray="4,2" opacity="0.6"/>
                  
            <line x1="0" y1="${height - ((sensorsConfig[Object.keys(sensorsConfig).find(k => sensorsConfig[k].color === color)]?.normalRange?.[1] - min) / range) * height || height/2}" 
                  x2="${width}" y2="${height - ((sensorsConfig[Object.keys(sensorsConfig).find(k => sensorsConfig[k].color === color)]?.normalRange?.[1] - min) / range) * height || height/2}" 
                  stroke="#22c55e" stroke-width="1" stroke-dasharray="4,2" opacity="0.6"/>
            
            <path d="M0,${height} L${points.replace(/ /g, ' L')} L${width},${height} Z" fill="url(#modal-grad)"/>
            <polyline points="${points}" fill="none" stroke="${color}" stroke-width="3" stroke-linecap="round"/>
            
            <!-- Puntos destacados -->
            ${data.map((value, index) => {
                if (index % 4 === 0 || index === data.length - 1) {
                    const x = (index / (data.length - 1)) * width;
                    const y = height - ((value - min) / range) * height;
                    return `
                        <circle cx="${x}" cy="${y}" r="4" fill="${color}" stroke="#ffffff" stroke-width="2"/>
                        <text x="${x}" y="${y - 12}" font-size="10" font-weight="600" fill="${color}" text-anchor="middle">
                            ${value.toFixed(1)}
                        </text>
                    `;
                }
                return '';
            }).join('')}
        </svg>
    `;
}

function closeTelemetryModal() {
    const modal = document.getElementById('ha-modal');
    if (modal) {
        modal.classList.add('is-hidden');
    }
}

// ===== INICIALIZACI√ìN =====
document.addEventListener('DOMContentLoaded', function() {
    console.log('üéØ Sistema de gr√°ficas IoT inicializado');
    
    // Conectar WebSocket para datos en tiempo real
    connectWebSocket();
    
    // Cargar datos hist√≥ricos del backend
    cargarDatosHistoricos();
    
    // Agregar event listeners a las tarjetas
    document.querySelectorAll('.js-sensor-card').forEach(card => {
        card.addEventListener('click', function() {
            const sensorId = this.getAttribute('data-key');
            openTelemetryModal(sensorId);
        });
    });
    
    // Cerrar modal
    const closeBtn = document.getElementById('ha-modal-close');
    const modal = document.getElementById('ha-modal');
    
    if (closeBtn) {
        closeBtn.addEventListener('click', closeTelemetryModal);
    }
    
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeTelemetryModal();
            }
        });
    }
    
    // Cerrar con ESC
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeTelemetryModal();
        }
    });
});

// Funci√≥n global para actualizar desde main.js
window.updateSensorData = function(sensorId, dataPoints) {
    if (sensorData[sensorId] && dataPoints && dataPoints.length > 0) {
        const values = dataPoints.map(point => point.v);
        sensorData[sensorId] = values.slice(-20); // Mantener √∫ltimos 20 puntos
        actualizarTodasSparklines();
    }
};
</script>

</body>
</html>

